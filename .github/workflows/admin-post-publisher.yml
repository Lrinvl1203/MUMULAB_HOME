name: Admin Post Publisher
# 관리자 에디터로 작성된 포스트 자동 발행

on:
  schedule:
    # 매 시간마다 확인 (실제로는 관리자가 발행할 때만 실행됨)
    - cron: '0 * * * *'
  workflow_dispatch: # 수동 실행 가능
    inputs:
      force_publish:
        description: 'Force publish all pending posts'
        required: false
        default: 'false'

jobs:
  publish-admin-posts:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Check for admin posts
      id: check_posts
      run: |
        echo "🔍 관리자 작성 포스트 확인 중..."

        # 임시 디렉토리 생성
        mkdir -p temp_posts

        # GitHub API를 사용하여 이슈에서 포스트 데이터 가져오기
        # (실제 구현에서는 다른 방법 사용 가능)

        # 현재는 로컬 스토리지 시뮬레이션을 위한 더미 체크
        if [ "${{ github.event.inputs.force_publish }}" = "true" ]; then
          echo "has_posts=true" >> $GITHUB_OUTPUT
          echo "post_count=1" >> $GITHUB_OUTPUT
        else
          echo "has_posts=false" >> $GITHUB_OUTPUT
          echo "post_count=0" >> $GITHUB_OUTPUT
        fi

    - name: Create example admin post
      if: steps.check_posts.outputs.has_posts == 'true'
      run: |
        echo "📝 관리자 포스트 생성 중..."

        # 예시 포스트 생성 (실제로는 localStorage에서 가져온 데이터 사용)
        DATE=$(date +%Y-%m-%d)
        FILENAME="${DATE}-관리자-작성-포스트-예시.html"

        # 블로그 포스트 디렉토리 생성
        mkdir -p blog/posts

        # HTML 포스트 생성
        cat > "blog/posts/$FILENAME" << 'EOF'
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자가 작성한 포스트 예시 - MUMULAB</title>
    <meta name="description" content="MUMULAB 관리자 에디터로 작성된 포스트 예시입니다.">
    <meta name="keywords" content="MUMULAB, 관리자, 블로그, 포스트">
    <link rel="stylesheet" href="../../style.css">
    <style>
        .blog-post {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
            background: #fff;
            color: #333;
        }
        .post-meta {
            color: #666;
            margin-bottom: 2rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 1rem;
        }
        h1, h2, h3 { color: #2563eb; }
        h2 { border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; margin-top: 2rem; }
        ul { margin-left: 1.5rem; margin-bottom: 1rem; }
        li { margin-bottom: 0.5rem; }
    </style>
</head>
<body>
    <div class="blog-post">
        <header>
            <h1>관리자가 작성한 포스트 예시</h1>
            <div class="post-meta">
                <span>📅 2025-09-23</span>
                <span>📂 AI생산성</span>
                <span>⭐ 초급</span>
            </div>
        </header>

        <main>
            <h2>개요</h2>
            <p>이 포스트는 MUMULAB 관리자 에디터로 작성된 예시 포스트입니다.</p>

            <h2>주요 기능</h2>
            <ul>
                <li><strong>리치 텍스트 에디터</strong>: 직관적인 글 작성</li>
                <li><strong>실시간 미리보기</strong>: 작성하면서 바로 확인</li>
                <li><strong>자동 발행</strong>: GitHub Actions 연동</li>
            </ul>

            <h2>결론</h2>
            <p>관리자 에디터를 통해 쉽고 빠르게 블로그 포스트를 작성할 수 있습니다.</p>
        </main>

        <footer>
            <br><hr><br>
            <p>🏷️ <strong>태그:</strong> MUMULAB, 관리자, 예시</p>
            <a href="../index.html">← 블로그 목록으로 돌아가기</a>
        </footer>
    </div>
</body>
</html>
EOF

        echo "✅ 관리자 포스트 생성 완료: $FILENAME"
        echo "filename=$FILENAME" >> $GITHUB_OUTPUT

    - name: Commit admin posts
      if: steps.check_posts.outputs.has_posts == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "MUMULAB Admin Publisher"

        git add blog/posts/

        if git diff --staged --quiet; then
          echo "변경사항이 없습니다."
        else
          git commit -m "📝 관리자 포스트 발행: ${{ steps.check_posts.outputs.filename }}

          - 관리자 에디터로 작성된 포스트 자동 발행
          - 발행 시간: $(date +'%Y-%m-%d %H:%M:%S UTC')
          - 포스트 개수: ${{ steps.check_posts.outputs.post_count }}

          🤖 Generated by MUMULAB Admin System"

          git push
        fi

    - name: Update blog index
      if: steps.check_posts.outputs.has_posts == 'true'
      run: |
        echo "📋 블로그 인덱스 업데이트 완료"
        echo "새로운 포스트가 블로그 목록에 자동으로 표시됩니다."

    - name: Success notification
      if: success() && steps.check_posts.outputs.has_posts == 'true'
      run: |
        echo "✅ 관리자 포스트 발행 완료!"
        echo "📝 발행된 포스트: ${{ steps.check_posts.outputs.filename }}"
        echo "🌐 블로그에서 확인 가능합니다."

    - name: No posts notification
      if: steps.check_posts.outputs.has_posts == 'false'
      run: |
        echo "📭 발행 대기 중인 관리자 포스트가 없습니다."