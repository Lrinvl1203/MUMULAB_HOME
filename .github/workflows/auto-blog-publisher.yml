name: Generate All Blog Posts
# AI ìƒì‚°ì„± ë¸”ë¡œê·¸ 30ê°œ ì¼ê´„ ìƒì„± ì›Œí¬í”Œë¡œìš°

on:
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ì „ìš©
    inputs:
      regenerate:
        description: 'Regenerate all posts (true/false)'
        required: false
        default: 'false'
  push:
    branches: [ main ]
    paths: [ '.github/workflows/auto-blog-publisher.yml', '.github/scripts/generate-all-blog-posts.sh' ]

jobs:
  generate-all-posts:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Generate all blog posts
      id: generate
      run: |
        echo "ğŸš€ AI ìƒì‚°ì„± ë¸”ë¡œê·¸ ì‹œë¦¬ì¦ˆ 30ê°œ ì¼ê´„ ìƒì„± ì‹œì‘..."

        # ê¸°ì¡´ íŒŒì¼ í™•ì¸
        EXISTING_COUNT=$(find blog/posts/ -name "*.html" | wc -l || echo "0")
        echo "ê¸°ì¡´ ë¸”ë¡œê·¸ íŒŒì¼ ìˆ˜: $EXISTING_COUNT"

        # ì¬ìƒì„± ì—¬ë¶€ í™•ì¸
        REGENERATE="${{ github.event.inputs.regenerate || 'false' }}"

        if [ "$EXISTING_COUNT" -gt "20" ] && [ "$REGENERATE" != "true" ]; then
          echo "ğŸ“‹ ì´ë¯¸ ì¶©ë¶„í•œ ë¸”ë¡œê·¸ íŒŒì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤."
          echo "ì¬ìƒì„±í•˜ë ¤ë©´ workflow_dispatchì—ì„œ regenerate=trueë¡œ ì„¤ì •í•˜ì„¸ìš”."
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "action=skipped" >> $GITHUB_OUTPUT
          exit 0
        fi

        # ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ì¼ê´„ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        chmod +x .github/scripts/generate-all-blog-posts.sh
        .github/scripts/generate-all-blog-posts.sh

        # ìƒì„±ëœ íŒŒì¼ ìˆ˜ í™•ì¸
        NEW_COUNT=$(find blog/posts/ -name "*.html" | wc -l)
        echo "ìƒì„± í›„ ì´ íŒŒì¼ ìˆ˜: $NEW_COUNT"

        echo "completed=true" >> $GITHUB_OUTPUT
        echo "action=generated" >> $GITHUB_OUTPUT
        echo "file_count=$NEW_COUNT" >> $GITHUB_OUTPUT

    - name: Commit and push changes
      if: steps.generate.outputs.action == 'generated'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"

        git add blog/posts/

        if git diff --staged --quiet; then
          echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
        else
          git commit -m "ğŸ¤– AI ìƒì‚°ì„± ë¸”ë¡œê·¸ ì‹œë¦¬ì¦ˆ 30ê°œ ì¼ê´„ ìƒì„±

          ğŸ“ ìƒˆë¡œìš´ ë‚ ì§œ ê¸°ë°˜ ì‹œìŠ¤í…œ:
          - ëª¨ë“  ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ë¥¼ ë¯¸ë¦¬ ìƒì„±
          - JavaScriptë¡œ ë‚ ì§œ ê¸°ë°˜ ìë™ ê³µê°œ
          - ê³µê°œ ì „ê¹Œì§€ 'Coming Soon' ë©”ì‹œì§€ í‘œì‹œ
          - ë§¤ì¼ í•˜ë‚˜ì”© ìë™ìœ¼ë¡œ ê³µê°œë¨

          ğŸ“Š ìƒì„±ëœ íŒŒì¼ ìˆ˜: ${{ steps.generate.outputs.file_count }}ê°œ
          ğŸ“… ìƒì„± ì‹œê°„: $(date +'%Y-%m-%d %H:%M:%S UTC')

          ğŸ¤– Generated with GitHub Actions"

          git push
        fi

    - name: Success notification
      if: success() && steps.generate.outputs.action == 'generated'
      run: |
        echo "âœ… ì„±ê³µ: AI ìƒì‚°ì„± ë¸”ë¡œê·¸ ì‹œë¦¬ì¦ˆ 30ê°œê°€ ëª¨ë‘ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ“Š ì´ ìƒì„±ëœ íŒŒì¼: ${{ steps.generate.outputs.file_count }}ê°œ"
        echo "ğŸ¯ ì‹œìŠ¤í…œ: ë‚ ì§œ ê¸°ë°˜ ìë™ ê³µê°œ ë°©ì‹"
        echo "ğŸ“… ë§¤ì¼ í•˜ë£¨ì— í•˜ë‚˜ì”© ìë™ìœ¼ë¡œ ê³µê°œë©ë‹ˆë‹¤."

    - name: Skipped notification
      if: steps.generate.outputs.action == 'skipped'
      run: |
        echo "ğŸ“‹ ì´ë¯¸ ì¶©ë¶„í•œ ë¸”ë¡œê·¸ íŒŒì¼ì´ ì¡´ì¬í•˜ì—¬ ìƒì„±ì„ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤."
        echo "ğŸ”§ ì¬ìƒì„±í•˜ë ¤ë©´ Actionsì—ì„œ workflow_dispatchë¥¼ ì‚¬ìš©í•˜ê³  regenerate=trueë¡œ ì„¤ì •í•˜ì„¸ìš”."