name: Generate All Blog Posts
# AI 생산성 블로그 30개 일괄 생성 워크플로우

on:
  workflow_dispatch: # 수동 실행 전용
    inputs:
      regenerate:
        description: 'Regenerate all posts (true/false)'
        required: false
        default: 'false'
  push:
    branches: [ main ]
    paths: [ '.github/workflows/auto-blog-publisher.yml', '.github/scripts/generate-all-blog-posts.sh' ]

jobs:
  generate-all-posts:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Generate all blog posts
      id: generate
      run: |
        echo "🚀 AI 생산성 블로그 시리즈 30개 일괄 생성 시작..."

        # 기존 파일 확인
        EXISTING_COUNT=$(find blog/posts/ -name "*.html" | wc -l || echo "0")
        echo "기존 블로그 파일 수: $EXISTING_COUNT"

        # 재생성 여부 확인
        REGENERATE="${{ github.event.inputs.regenerate || 'false' }}"

        if [ "$EXISTING_COUNT" -gt "20" ] && [ "$REGENERATE" != "true" ]; then
          echo "📋 이미 충분한 블로그 파일이 존재합니다."
          echo "재생성하려면 workflow_dispatch에서 regenerate=true로 설정하세요."
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "action=skipped" >> $GITHUB_OUTPUT
          exit 0
        fi

        # 블로그 포스트 일괄 생성 스크립트 실행
        chmod +x .github/scripts/generate-all-blog-posts.sh
        .github/scripts/generate-all-blog-posts.sh

        # 생성된 파일 수 확인
        NEW_COUNT=$(find blog/posts/ -name "*.html" | wc -l)
        echo "생성 후 총 파일 수: $NEW_COUNT"

        echo "completed=true" >> $GITHUB_OUTPUT
        echo "action=generated" >> $GITHUB_OUTPUT
        echo "file_count=$NEW_COUNT" >> $GITHUB_OUTPUT

    - name: Commit and push changes
      if: steps.generate.outputs.action == 'generated'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"

        git add blog/posts/

        if git diff --staged --quiet; then
          echo "변경사항이 없습니다."
        else
          git commit -m "🤖 AI 생산성 블로그 시리즈 30개 일괄 생성

          📝 새로운 날짜 기반 시스템:
          - 모든 블로그 포스트를 미리 생성
          - JavaScript로 날짜 기반 자동 공개
          - 공개 전까지 'Coming Soon' 메시지 표시
          - 매일 하나씩 자동으로 공개됨

          📊 생성된 파일 수: ${{ steps.generate.outputs.file_count }}개
          📅 생성 시간: $(date +'%Y-%m-%d %H:%M:%S UTC')

          🤖 Generated with GitHub Actions"

          git push
        fi

    - name: Success notification
      if: success() && steps.generate.outputs.action == 'generated'
      run: |
        echo "✅ 성공: AI 생산성 블로그 시리즈 30개가 모두 생성되었습니다!"
        echo "📊 총 생성된 파일: ${{ steps.generate.outputs.file_count }}개"
        echo "🎯 시스템: 날짜 기반 자동 공개 방식"
        echo "📅 매일 하루에 하나씩 자동으로 공개됩니다."

    - name: Skipped notification
      if: steps.generate.outputs.action == 'skipped'
      run: |
        echo "📋 이미 충분한 블로그 파일이 존재하여 생성을 건너뛰었습니다."
        echo "🔧 재생성하려면 Actions에서 workflow_dispatch를 사용하고 regenerate=true로 설정하세요."