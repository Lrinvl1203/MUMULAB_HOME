name: Auto Blog Publisher
# AI ìƒì‚°ì„± ë¸”ë¡œê·¸ ìë™ ë°œí–‰ ì›Œí¬í”Œë¡œìš°

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST 18:00 UTC) ì‹¤í–‰
    - cron: '0 0 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  BLOG_SERIES_INDEX: ${{ vars.BLOG_SERIES_INDEX || '0' }}

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm init -y
        npm install marked

    - name: Generate blog post
      id: generate
      run: |
        # Node.js ìŠ¤í¬ë¦½íŠ¸ë¡œ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ìƒì„±
        cat > generate-post.js << 'EOF'
        const fs = require('fs');
        const path = require('path');

        // AI ìƒì‚°ì„± ë¸”ë¡œê·¸ ì‹œë¦¬ì¦ˆ ë°ì´í„°
        const blogSeries = [
          {
            title: "AIë¡œ í•˜ë£¨ 1ì‹œê°„ ì ˆì•½í•˜ê¸° - ì¼ì • ê´€ë¦¬ ìë™í™”",
            category: "ì‹œê°„ê´€ë¦¬",
            content: "Google Calendar AI, Calendly, Motion ë“±ì„ í™œìš©í•œ ìŠ¤ë§ˆíŠ¸ ì¼ì • ê´€ë¦¬",
            tags: ["ì‹œê°„ê´€ë¦¬", "ì¼ì •ìë™í™”", "AIë„êµ¬"],
            difficulty: "ì´ˆê¸‰"
          },
          {
            title: "ìŠ¤ë§ˆíŠ¸í°ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” AI ìƒì‚°ì„± - í•„ìˆ˜ ì•± 5ì„ ",
            category: "ëª¨ë°”ì¼AI",
            content: "Otter.ai, Grammarly, Todoist AI, Notion AI ë“± ëª¨ë°”ì¼ AI ì•± í™œìš©ë²•",
            tags: ["ëª¨ë°”ì¼", "ì•±ì¶”ì²œ", "ìƒì‚°ì„±"],
            difficulty: "ì´ˆê¸‰"
          },
          {
            title: "AI ìŒì„±ì¸ì‹ìœ¼ë¡œ ì—…ë¬´ íš¨ìœ¨ 10ë°° ë†’ì´ê¸°",
            category: "ìŒì„±AI",
            content: "Whisper, Dragon, ë„¤ì´ë²„ í´ë¡œë°” ë“±ì„ í™œìš©í•œ ìŒì„± ì…ë ¥ ë° ëª…ë ¹",
            tags: ["ìŒì„±ì¸ì‹", "í•¸ì¦ˆí”„ë¦¬", "íš¨ìœ¨ì„±"],
            difficulty: "ì¤‘ê¸‰"
          },
          // ... ë” ë§ì€ ì£¼ì œë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë¨
        ];

        function generateBlogPost(topic, index) {
          const date = new Date();
          date.setDate(date.getDate() + index);

          const content = `# ${topic.title}

## ê°œìš”
${topic.content}

## ì£¼ìš” ê¸°ëŠ¥
- í•µì‹¬ ê¸°ëŠ¥ 1: AI ë„êµ¬ì˜ ì£¼ìš” íŠ¹ì§•
- í•µì‹¬ ê¸°ëŠ¥ 2: ì‹¤ìš©ì  í™œìš© ë°©ë²•
- í•µì‹¬ ê¸°ëŠ¥ 3: ìƒì‚°ì„± í–¥ìƒ íš¨ê³¼

## ë‹¨ê³„ë³„ ì‹¤í–‰ ê°€ì´ë“œ

### 1ë‹¨ê³„: ì¤€ë¹„í•˜ê¸°
- í•„ìš”í•œ ë„êµ¬ ë° ê³„ì • ì„¤ì •
- ì´ˆê¸° ì„¤ì • ë°©ë²•

### 2ë‹¨ê³„: ê¸°ë³¸ í™œìš©ë²•
- ê¸°ë³¸ ì‚¬ìš©ë²• ì•ˆë‚´
- ì£¼ìš” ê¸°ëŠ¥ í™œìš© ë°©ë²•

### 3ë‹¨ê³„: ê³ ê¸‰ í™œìš©ë²•
- ì‹¬í™” ê¸°ëŠ¥ ì‚¬ìš©ë²•
- ê°œì¸í™” ì„¤ì • ë°©ë²•

### 4ë‹¨ê³„: ìƒì‚°ì„± ê·¹ëŒ€í™”
- ë‹¤ë¥¸ ë„êµ¬ì™€ì˜ ì—°ë™ ë°©ë²•
- ì›Œí¬í”Œë¡œìš° ìµœì í™” íŒ

## ì‹¤ì œ ì‚¬ìš© ì‚¬ë¡€

### ì‚¬ë¡€ 1: ì¼ë°˜ì ì¸ ìƒí™©
- ë¬¸ì œ ìƒí™© ì„¤ëª…
- AI ë„êµ¬ ì ìš© ë°©ë²•
- ê²°ê³¼ ë° íš¨ê³¼ ì¸¡ì •

### ì‚¬ë¡€ 2: ê³ ê¸‰ í™œìš©
- ë³µì¡í•œ ìƒí™© ë¶„ì„
- ë‹¨ê³„ë³„ í•´ê²° ê³¼ì •
- ì„±ê³¼ ë° ROI ì¸¡ì •

## ì£¼ì˜ì‚¬í•­ ë° íŒ
- âš ï¸ ì£¼ì˜í•´ì•¼ í•  ì 
- ğŸ’¡ íš¨ìœ¨ì  ì‚¬ìš© íŒ
- ğŸ”§ ë¬¸ì œ í•´ê²° ë°©ë²•

## ë§ˆë¬´ë¦¬
${topic.title}ë¥¼ í†µí•´ ì¼ìƒ ìƒì‚°ì„±ì„ í¬ê²Œ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ë‹¨ê³„ë³„ë¡œ ì²œì²œíˆ ì ìš©í•´ë³´ì‹œê³ , ê°œì¸ ì›Œí¬í”Œë¡œìš°ì— ë§ê²Œ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•´ë³´ì„¸ìš”.

---
ğŸ“š **ê´€ë ¨ ê¸€ ì¶”ì²œ**
- ë‹¤ìŒ ì£¼ì œ ì˜ˆê³ 
- ê´€ë ¨ AI ë„êµ¬ ì†Œê°œ

ğŸ·ï¸ **íƒœê·¸**: ${topic.tags.join(', ')}
ğŸ“… **ì—…ë°ì´íŠ¸**: ${date.toLocaleDateString('ko-KR')}
`;

          return {
            title: topic.title,
            date: date.toISOString().split('T')[0],
            category: topic.category,
            tags: topic.tags,
            difficulty: topic.difficulty,
            content: content,
            filename: `${date.toISOString().split('T')[0]}-${topic.title.replace(/\s+/g, '-').replace(/[^\w-ê°€-í£]/g, '')}.md`
          };
        }

        function generateHTML(post) {
          return `<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${post.title} - MUMULAB</title>
    <meta name="description" content="${post.content.substring(0, 150)}...">
    <meta name="keywords" content="AI ìƒì‚°ì„±, ${post.tags.join(', ')}">
    <meta property="og:title" content="${post.title}">
    <meta property="og:description" content="${post.content.substring(0, 150)}...">
    <meta property="og:type" content="article">
    <link rel="stylesheet" href="../../style.css">
    <style>
        .blog-post {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
            background: #fff;
            color: #333;
        }
        .post-meta {
            color: #666;
            margin-bottom: 2rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 1rem;
        }
        .tags {
            margin-top: 2rem;
        }
        .tag {
            background: #f0f0f0;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin-right: 0.5rem;
            font-size: 0.9rem;
        }
        h1, h2, h3 { color: #2563eb; }
        h2 { border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; }
        ul { margin-left: 1.5rem; margin-bottom: 1rem; }
        li { margin-bottom: 0.5rem; }
    </style>
</head>
<body>
    <div class="blog-post">
        <header>
            <h1>${post.title}</h1>
            <div class="post-meta">
                <span>ğŸ“… ${new Date(post.date).toLocaleDateString('ko-KR')}</span>
                <span>ğŸ“‚ ${post.category}</span>
                <span>â­ ${post.difficulty}</span>
            </div>
        </header>

        <main>
            <div class="content">
                ${post.content.replace(/\n/g, '<br>')}
            </div>

            <div class="tags">
                ${post.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
            </div>
        </main>

        <footer>
            <br><hr><br>
            <a href="../index.html">â† ë¸”ë¡œê·¸ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </footer>
    </div>
</body>
</html>`;
        }

        // í˜„ì¬ ì¸ë±ìŠ¤ ê°€ì ¸ì˜¤ê¸°
        const currentIndex = parseInt(process.env.BLOG_SERIES_INDEX || '0');

        if (currentIndex >= blogSeries.length) {
          console.log('ëª¨ë“  ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ê°€ ìƒì„± ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          process.exit(0);
        }

        // í¬ìŠ¤íŠ¸ ìƒì„±
        const post = generateBlogPost(blogSeries[currentIndex], currentIndex);
        const html = generateHTML(post);

        // ë¸”ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
        const blogDir = path.join(__dirname, 'blog', 'posts');
        if (!fs.existsSync(blogDir)) {
          fs.mkdirSync(blogDir, { recursive: true });
        }

        // HTML íŒŒì¼ ì €ì¥
        const htmlPath = path.join(blogDir, post.filename.replace('.md', '.html'));
        fs.writeFileSync(htmlPath, html);

        // ë§ˆí¬ë‹¤ìš´ íŒŒì¼ë„ ì €ì¥
        const mdPath = path.join(blogDir, post.filename);
        fs.writeFileSync(mdPath, post.content);

        console.log(`âœ… ìƒˆ í¬ìŠ¤íŠ¸ ìƒì„±: ${post.title}`);
        console.log(`ğŸ“„ íŒŒì¼: ${post.filename}`);
        console.log(`ğŸ“… ë‚ ì§œ: ${post.date}`);

        // GitHub Actions ì¶œë ¥ ì„¤ì •
        console.log(`::set-output name=title::${post.title}`);
        console.log(`::set-output name=filename::${post.filename.replace('.md', '.html')}`);
        console.log(`::set-output name=next-index::${currentIndex + 1}`);

        EOF

        node generate-post.js

    - name: Update blog index
      run: |
        # ë¸”ë¡œê·¸ ì¸ë±ìŠ¤ í˜ì´ì§€ ì—…ë°ì´íŠ¸
        echo "ğŸ“ ë¸”ë¡œê·¸ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸ ì¤‘..."

        # ì—¬ê¸°ì— ë¸”ë¡œê·¸ ëª©ë¡ í˜ì´ì§€ ì—…ë°ì´íŠ¸ ë¡œì§ ì¶”ê°€
        # ì˜ˆ: blog/index.htmlì— ìƒˆ í¬ìŠ¤íŠ¸ ë§í¬ ì¶”ê°€

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add blog/posts/
        git add blog/index.html || true

        if git diff --staged --quiet; then
          echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
        else
          git commit -m "ğŸ¤– ìë™ ìƒì„±: ${{ steps.generate.outputs.title }}

          - íŒŒì¼: ${{ steps.generate.outputs.filename }}
          - ì‹œë¦¬ì¦ˆ: AI ìƒì‚°ì„± í–¥ìƒ (${{ env.BLOG_SERIES_INDEX }}/30)
          - ìë™ ìƒì„± ì‹œê°„: $(date +'%Y-%m-%d %H:%M:%S')"

          git push
        fi

    - name: Update series index
      uses: actions/github-script@v7
      with:
        script: |
          const nextIndex = '${{ steps.generate.outputs.next-index }}';

          await github.rest.actions.createOrUpdateRepoVariable({
            owner: context.repo.owner,
            repo: context.repo.repo,
            name: 'BLOG_SERIES_INDEX',
            value: nextIndex
          });

          console.log(`ğŸ“Š ì‹œë¦¬ì¦ˆ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸: ${nextIndex}`);

    - name: Create success notification
      if: success()
      run: |
        echo "âœ… ì„±ê³µ: ${{ steps.generate.outputs.title }} í¬ìŠ¤íŠ¸ê°€ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ“… ë‹¤ìŒ í¬ìŠ¤íŠ¸ëŠ” ë‚´ì¼ ê°™ì€ ì‹œê°„ì— ìë™ ìƒì„±ë©ë‹ˆë‹¤."

    - name: Handle completion
      if: env.BLOG_SERIES_INDEX >= 30
      run: |
        echo "ğŸ‰ AI ìƒì‚°ì„± ë¸”ë¡œê·¸ ì‹œë¦¬ì¦ˆ 30ê°œ ëª¨ë‘ ì™„ì„±!"
        echo "ìë™ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ ë¹„í™œì„±í™”í•©ë‹ˆë‹¤."

        # ì›Œí¬í”Œë¡œìš° ë¹„í™œì„±í™” (ì„ íƒì )
        # gh workflow disable auto-blog-publisher.yml