name: Auto Blog Publisher
# AI ìƒì‚°ì„± ë¸”ë¡œê·¸ ìë™ ë°œí–‰ ì›Œí¬í”Œë¡œìš°

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST) = UTC 0ì‹œ ì‹¤í–‰
    - cron: '0 0 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      series_index:
        description: 'Blog series index (0-29)'
        required: false
        default: '0'
  push:
    branches: [ main ]
    paths: [ '.github/workflows/auto-blog-publisher.yml' ]

env:
  BLOG_SERIES_INDEX: ${{ github.event.inputs.series_index || vars.BLOG_SERIES_INDEX || '0' }}

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Generate blog post
      id: generate
      run: |
        echo "ğŸš€ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ìƒì„± ì‹œì‘..."

        # í˜„ì¬ ì¸ë±ìŠ¤ í™•ì¸
        CURRENT_INDEX=${BLOG_SERIES_INDEX:-0}
        echo "í˜„ì¬ ì‹œë¦¬ì¦ˆ ì¸ë±ìŠ¤: $CURRENT_INDEX"

        # ì‹œë¦¬ì¦ˆ ì™„ë£Œ í™•ì¸
        if [ "$CURRENT_INDEX" -ge 30 ]; then
          echo "ğŸ‰ ë¸”ë¡œê·¸ ì‹œë¦¬ì¦ˆ 30ê°œ ëª¨ë‘ ì™„ì„±!"
          echo "completed=true" >> $GITHUB_OUTPUT
          exit 0
        fi

        # ë¸”ë¡œê·¸ ì£¼ì œ ë°°ì—´
        TOPICS=(
          "AIë¡œ í•˜ë£¨ 1ì‹œê°„ ì ˆì•½í•˜ê¸° - ì¼ì • ê´€ë¦¬ ìë™í™”"
          "ìŠ¤ë§ˆíŠ¸í°ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” AI ìƒì‚°ì„± - í•„ìˆ˜ ì•± 5ì„ "
          "AI ìŒì„±ì¸ì‹ìœ¼ë¡œ ì—…ë¬´ íš¨ìœ¨ 10ë°° ë†’ì´ê¸°"
          "ChatGPTë¡œ ì´ë©”ì¼ ì‘ì„± ì‹œê°„ 90% ë‹¨ì¶•í•˜ê¸°"
          "AI ìš”ì•½ ë„êµ¬ë¡œ ì •ë³´ ê³¼ë¶€í•˜ í•´ê²°í•˜ê¸°"
          "ê°œì¸ ë§ì¶¤í˜• AI ë¹„ì„œ ë§Œë“¤ê¸° - GPT ì»¤ìŠ¤í…€ í™œìš©ë²•"
          "AI ë²ˆì—­ìœ¼ë¡œ ê¸€ë¡œë²Œ ì†Œí†µì˜ ë²½ í—ˆë¬¼ê¸°"
          "AIë¡œ 10ë¶„ ë§Œì— í”„ë ˆì  í…Œì´ì…˜ ì™„ì„±í•˜ê¸°"
          "AI ì´ë¯¸ì§€ ìƒì„±ìœ¼ë¡œ ì½˜í…ì¸  ì œì‘ í˜ì‹ í•˜ê¸°"
          "AI ê¸€ì“°ê¸° ë„êµ¬ë¡œ ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… ìë™í™”í•˜ê¸°"
          "AI ë™ì˜ìƒ í¸ì§‘ìœ¼ë¡œ ìœ íŠœë¸Œ ì½˜í…ì¸  ì œì‘ ê°€ì†í™”"
          "AI ìŒì•… ìƒì„±ìœ¼ë¡œ ê°œì¸ ë¸Œëœë”© ì‚¬ìš´ë“œ ë§Œë“¤ê¸°"
          "AI ì½”ë”© ì–´ì‹œìŠ¤í„´íŠ¸ë¡œ í”„ë¡œê·¸ë˜ë° ìƒì‚°ì„± ê·¹ëŒ€í™”"
          "AI ë””ìì¸ ë„êµ¬ë¡œ ì „ë¬¸ê°€ê¸‰ ê·¸ë˜í”½ ë””ìì¸í•˜ê¸°"
          "AI ë°ì´í„° ë¶„ì„ìœ¼ë¡œ ê°œì¸ íŒ¨í„´ ë°œê²¬í•˜ê¸°"
          "AI ì˜ˆì¸¡ ëª¨ë¸ë¡œ ê°œì¸ ëª©í‘œ ë‹¬ì„±ë¥  ë†’ì´ê¸°"
          "AI ì¶”ì²œ ì‹œìŠ¤í…œìœ¼ë¡œ íš¨ìœ¨ì ì¸ í•™ìŠµ ê²½ë¡œ ì„¤ê³„í•˜ê¸°"
          "AI ì¬ì • ê´€ë¦¬ë¡œ ìŠ¤ë§ˆíŠ¸í•œ ê°€ê³„ë¶€ ìš´ì˜í•˜ê¸°"
          "AI ê±´ê°• ëª¨ë‹ˆí„°ë§ìœ¼ë¡œ ì›°ë¹™ ë¼ì´í”„ ì‹¤í˜„í•˜ê¸°"
          "AI íŠ¸ë Œë“œ ë¶„ì„ìœ¼ë¡œ íˆ¬ì ì¸ì‚¬ì´íŠ¸ ì–»ê¸°"
          "AI ê²½ë ¥ ë¶„ì„ìœ¼ë¡œ ì»¤ë¦¬ì–´ ë¡œë“œë§µ ê·¸ë¦¬ê¸°"
          "AI ì›Œí¬í”Œë¡œìš° ìë™í™”ë¡œ ë°˜ë³µ ì—…ë¬´ ì œë¡œ ë§Œë“¤ê¸°"
          "ê°œì¸ìš© AI ì±—ë´‡ êµ¬ì¶•ìœ¼ë¡œ 24ì‹œê°„ ì–´ì‹œìŠ¤í„´íŠ¸ ë§Œë“¤ê¸°"
          "AI í†µí•© ëŒ€ì‹œë³´ë“œë¡œ ëª¨ë“  ì •ë³´ í•œëˆˆì— ê´€ë¦¬í•˜ê¸°"
          "AI í”¼ë“œë°± ë£¨í”„ë¡œ ì§€ì†ì ì¸ ê°œì¸ ì„±ì¥ ì‹œìŠ¤í…œ ë§Œë“¤ê¸°"
          "AI í˜‘ì—… ë„êµ¬ë¡œ íŒ€ ìƒì‚°ì„± 10ë°° í–¥ìƒì‹œí‚¤ê¸°"
          "AI ë³´ì•ˆ ë„êµ¬ë¡œ ê°œì¸ì •ë³´ ë° ë””ì§€í„¸ ìì‚° ë³´í˜¸í•˜ê¸°"
          "2024ë…„ ì£¼ëª©í•´ì•¼ í•  ì‹ í¥ AI ë„êµ¬ 10ì„ "
          "AI ìœ¤ë¦¬ì™€ ê°œì¸ ìƒì‚°ì„±ì˜ ê· í˜•ì  ì°¾ê¸°"
          "AI ì‹œëŒ€ì˜ ìƒˆë¡œìš´ ìƒì‚°ì„± íŒ¨ëŸ¬ë‹¤ì„"
        )

        # í˜„ì¬ ì£¼ì œ ì„ íƒ
        if [ "$CURRENT_INDEX" -lt "${#TOPICS[@]}" ]; then
          CURRENT_TOPIC="${TOPICS[$CURRENT_INDEX]}"
        else
          echo "âŒ ì¸ë±ìŠ¤ê°€ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤: $CURRENT_INDEX"
          exit 1
        fi

        # ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        chmod +x .github/scripts/generate-blog-post.sh
        OUTPUT=$(.github/scripts/generate-blog-post.sh "$CURRENT_TOPIC" "$CURRENT_INDEX")

        # ì¶œë ¥ì—ì„œ ì •ë³´ ì¶”ì¶œ
        FILENAME=$(echo "$OUTPUT" | grep "filename=" | cut -d'=' -f2)

        echo "title=$CURRENT_TOPIC" >> $GITHUB_OUTPUT
        echo "filename=$FILENAME" >> $GITHUB_OUTPUT
        echo "next_index=$((CURRENT_INDEX + 1))" >> $GITHUB_OUTPUT
        echo "completed=false" >> $GITHUB_OUTPUT

    - name: Commit and push changes
      if: steps.generate.outputs.completed != 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"

        git add blog/posts/

        if git diff --staged --quiet; then
          echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
        else
          git commit -m "ğŸ¤– ìë™ ìƒì„±: ${{ steps.generate.outputs.title }}

          - íŒŒì¼: ${{ steps.generate.outputs.filename }}
          - ì‹œë¦¬ì¦ˆ: AI ìƒì‚°ì„± í–¥ìƒ (${{ env.BLOG_SERIES_INDEX }}/30)
          - ìë™ ìƒì„± ì‹œê°„: $(date +'%Y-%m-%d %H:%M:%S UTC')

          ğŸ¤– Generated with GitHub Actions"

          git push
        fi

    - name: Update series index
      if: steps.generate.outputs.completed != 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const nextIndex = '${{ steps.generate.outputs.next_index }}';

          try {
            await github.rest.actions.createOrUpdateRepoVariable({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'BLOG_SERIES_INDEX',
              value: nextIndex
            });
            console.log(`ğŸ“Š ì‹œë¦¬ì¦ˆ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸ ì„±ê³µ: ${nextIndex}`);
          } catch (error) {
            console.log(`ğŸ“Š ì‹œë¦¬ì¦ˆ ì¸ë±ìŠ¤ ì„¤ì •: ${nextIndex} (ë³€ìˆ˜ê°€ ì—†ì–´ì„œ ìƒˆë¡œ ìƒì„±)`);
          }

    - name: Success notification
      if: success() && steps.generate.outputs.completed != 'true'
      run: |
        echo "âœ… ì„±ê³µ: '${{ steps.generate.outputs.title }}' í¬ìŠ¤íŠ¸ê°€ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ“… ë‹¤ìŒ í¬ìŠ¤íŠ¸ëŠ” ë‚´ì¼ ê°™ì€ ì‹œê°„ì— ìë™ ìƒì„±ë©ë‹ˆë‹¤."
        echo "ğŸ”— íŒŒì¼: ${{ steps.generate.outputs.filename }}"

    - name: Series completion
      if: steps.generate.outputs.completed == 'true'
      run: |
        echo "ğŸ‰ AI ìƒì‚°ì„± ë¸”ë¡œê·¸ ì‹œë¦¬ì¦ˆ 30ê°œ ëª¨ë‘ ì™„ì„±!"
        echo "ğŸ“Š ì´ 30ê°œì˜ í¬ìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."